<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: ruby | As a SW/Ops/DB Engineer]]></title>
  <link href="http://tech.riywo.com/blog/categories/ruby/atom.xml" rel="self"/>
  <link href="http://tech.riywo.com/"/>
  <updated>2013-06-22T10:26:27-07:00</updated>
  <id>http://tech.riywo.com/</id>
  <author>
    <name><![CDATA[riywo]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Using columns of a intermediate table with ActiveRecord has_many association]]></title>
    <link href="http://tech.riywo.com/blog/2013/06/22/using-columns-of-a-intermediate-table-with-activerecord-has-many-association/"/>
    <updated>2013-06-22T09:51:00-07:00</updated>
    <id>http://tech.riywo.com/blog/2013/06/22/using-columns-of-a-intermediate-table-with-activerecord-has-many-association</id>
    <content type="html"><![CDATA[<p>I have n:m relation tables and want to use columns of the intermediate table.</p>

<pre><code>activerecord (4.0.0.rc2)

class User &lt; ActiveRecord::Base
  has_many :user_bookmarks
  has_many :bookmarks, through: :user_bookmarks
end

class UserBookmark &lt; ActiveRecord::Base
  belongs_to :user
  belongs_to :bookmark
  # has column "star"
end

class Bookmark &lt; ActiveRecord::Base
  has_many :user_bookmarks
  has_many :users, through: :user_bookmarks
end

&gt; User.first.bookmarks.first.star
NoMethodError: undefined method `star' for #&lt;Bookmark:0x007ff40e45a7b8&gt;
</code></pre>

<!-- more -->


<p>I used a scope block for <code>has_many</code>.</p>

<pre><code>class User &lt; ActiveRecord::Base
  has_many :user_bookmarks
  has_many :bookmarks, -&gt; { select("bookmarks.*, user_bookmarks.star") }, through: :user_bookmarks
end

&gt; User.first.bookmarks.first.star
10
</code></pre>

<p>I&rsquo;m not sure whether this is the best way for the purpose, but it works.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[ruby-build --enable-load-relative]]></title>
    <link href="http://tech.riywo.com/blog/2013/06/22/ruby-build-enable-load-relative/"/>
    <updated>2013-06-22T09:27:00-07:00</updated>
    <id>http://tech.riywo.com/blog/2013/06/22/ruby-build-enable-load-relative</id>
    <content type="html"><![CDATA[<p>CRuby builds a ruby binary and scripts with the absolute path hard corded.</p>

<pre><code>$ strings /Users/riywo/.rbenv/versions/1.9.3-p327/bin/ruby | grep rbenv
/Users/riywo/.rbenv/versions/1.9.3-p327
/Users/riywo/.rbenv/versions/1.9.3-p327/lib/ruby/site_ruby/1.9.1
/Users/riywo/.rbenv/versions/1.9.3-p327/lib/ruby/site_ruby/1.9.1/x86_64-darwin12.2.0
/Users/riywo/.rbenv/versions/1.9.3-p327/lib/ruby/site_ruby
/Users/riywo/.rbenv/versions/1.9.3-p327/lib/ruby/vendor_ruby/1.9.1
/Users/riywo/.rbenv/versions/1.9.3-p327/lib/ruby/vendor_ruby/1.9.1/x86_64-darwin12.2.0
/Users/riywo/.rbenv/versions/1.9.3-p327/lib/ruby/vendor_ruby
/Users/riywo/.rbenv/versions/1.9.3-p327/lib/ruby/1.9.1
/Users/riywo/.rbenv/versions/1.9.3-p327/lib/ruby/1.9.1/x86_64-darwin12.2.0

$ head -1  /Users/riywo/.rbenv/versions/1.9.3-p327/bin/gem
#!/Users/riywo/.rbenv/versions/1.9.3-p327/bin/ruby 
</code></pre>

<!-- more -->


<p>So, if you move the installed directory location, the ruby and scripts don&rsquo;t work. To avoid this kind of problems, you can use <code>--enable-load-relative</code> configure option.</p>

<pre><code>$ RUBY_CONFIGURE_OPTS="--enable-load-relative" rbenv install 1.9.3-p327

$ strings /Users/riywo/.rbenv/versions/1.9.3-p327/bin/ruby | grep rbenv

$ head -8 /Users/riywo/.rbenv/versions/1.9.3-p327/bin/gem
#!/bin/sh
# -*- ruby -*-
bindir=`cd -P "${0%/*}" 2&gt;/dev/null; pwd`
prefix="${bindir%/bin}"
export DYLD_LIBRARY_PATH="$prefix/lib${DYLD_LIBRARY_PATH:+:$DYLD_LIBRARY_PATH}"
exec "$bindir/ruby" -x "$0" "$@"
#!/usr/bin/env ruby
#--
</code></pre>

<p>See also <a href="http://yehudakatz.com/2012/06/05/tokaido-status-update-implementation-details/">Tokaido Status Update: Implementation Details « Katz Got Your Tongue?</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[webtail + ncat = simple log monitoring!]]></title>
    <link href="http://tech.riywo.com/blog/2013/04/23/webtail-plus-ncat-equals-simple-log-monitoring-slash/"/>
    <updated>2013-04-23T18:58:00-07:00</updated>
    <id>http://tech.riywo.com/blog/2013/04/23/webtail-plus-ncat-equals-simple-log-monitoring-slash</id>
    <content type="html"><![CDATA[<p><a href="https://github.com/r7kamura/webtail">webtail</a> is a super simple log monitoring tool. You can monitor a log streaming on a server via your web browser.</p>

<p>I wanted to monitor multi servers log, so I tried <code>ncat</code> in <code>mmap</code>. <code>ncat</code> supports multi sessions.</p>

<ul>
<li><a href="http://nmap.org/ncat/">Ncat &ndash; Netcat for the 21st Century</a></li>
</ul>


<!-- more -->


<p>Here is an example.</p>

<pre><code>## monitor server
mon&gt; ncat -l -k 10000 | webtail

## web servers
web1&gt; tail -F access_log | sed -e 's/^/web1 /' | nc mon 10000
web2&gt; tail -F access_log | sed -e 's/^/web2 /' | nc mon 10000
web3&gt; tail -F access_log | sed -e 's/^/web3 /' | nc mon 10000
</code></pre>

<p>You can monitor all web servers logs with a single web page.</p>

<p>Enjoy!</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Yet Another shell script]]></title>
    <link href="http://tech.riywo.com/blog/2013/04/19/yet-another-shell-script/"/>
    <updated>2013-04-19T14:54:00-07:00</updated>
    <id>http://tech.riywo.com/blog/2013/04/19/yet-another-shell-script</id>
    <content type="html"><![CDATA[<p>How about such an alternative shell script?</p>

<!-- more -->




<script src="https://gist.github.com/riywo/5423408.js"></script>


<p>I will try to implement this in ruby for POC.</p>

<h3>P.S.</h3>

<p>Here is a draft written by @okitan, awesome!</p>

<script src="https://gist.github.com/okitan/5423791.js"></script>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[multiple assignment from regexp]]></title>
    <link href="http://tech.riywo.com/blog/2013/04/17/multiple-assignment-from-regexp/"/>
    <updated>2013-04-17T18:22:00-07:00</updated>
    <id>http://tech.riywo.com/blog/2013/04/17/multiple-assignment-from-regexp</id>
    <content type="html"><![CDATA[<p>Sometimes I want to assign multiple variables from results of regexp matching. Here are the ways in some LLs.</p>

<!-- more -->


<h3>Perl</h3>

<pre><code>my ($a, $b) = ("a:1 b:2" =~ /a:(\d) b:(\d)/);
# or
my ($a, $b) = "a:1 b:2" =~ /a:(\d) b:(\d)/;
</code></pre>

<h3>Ruby</h3>

<pre><code>a, b = "a:1 b:2".match(/a:(\d) b:(\d)/) {[$1, $2]}
# or
a, b = "a:1 b:2".match(/a:(\d) b:(\d)/).to_a[1, 2]
</code></pre>

<h3>Python</h3>

<pre><code>import re
a, b = re.match(r'a:(\d) b:(\d)', "a:1 b:2").group(1, 2)
</code></pre>

<h2>Conclusion</h2>

<ul>
<li>Perl

<ul>
<li>simplest</li>
<li>needs parentheses for multiple assignment

<ul>
<li>parentheses for matching are not mandatory, though</li>
</ul>
</li>
</ul>
</li>
<li>Ruby

<ul>
<li><code>match</code> is a method of <code>String</code> class</li>
<li>give a block or slice an array</li>
</ul>
</li>
<li>Python

<ul>
<li>needs <code>re</code> module</li>
<li><code>match</code> is a method of <code>re</code></li>
</ul>
</li>
</ul>


<p>Enjoy!</p>

<hr />

<p>簡単にファイルをパースしたい時とかに、Perlで書いた正規表現でさくっと変数に多重代入したりしてたんですが、Ruby/Pythonだとどうやるのか分からなかったのでまとめ。Thanks to @_shimada, @methane, @kyoendo, @toku_bass</p>

<p>namedcapture版も作ってみたい。というかそもそもオレオレLL比較チートシート作りたい。</p>

<ul>
<li>参考

<ul>
<li><a href="http://0xcc.net/blog/archives/000137.html">文字列操作の比較表: Ruby, Python, JavaScript, Perl, C++ &ndash; bkブログ</a></li>
</ul>
</li>
</ul>

]]></content>
  </entry>
  
</feed>


<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Terraform module for Mesos + Ceph cluster and Packer template - As a SW/Ops/DB Engineer</title>
  <meta name="author" content="riywo">

  
  <meta name="description" content="riywo/mesos-ceph I&rsquo;ve just tried to use Terraform and Packer to create a Mesos + Ceph cluster in AWS. Yes, I know Mesosphere applications &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://tech.riywo.com/blog/2014/12/25/terraform-module-for-mesos-plus-ceph-cluster-and-packer-template">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="As a SW/Ops/DB Engineer" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">As a SW/Ops/DB Engineer</a></h1>
  
    <h2>riywo&#8217;s technology memo</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:tech.riywo.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Terraform Module for Mesos + Ceph Cluster and Packer Template</h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-12-25T23:13:16+09:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


<div class="entry-content"><p><a href="https://github.com/riywo/mesos-ceph">riywo/mesos-ceph</a></p>

<p>I&rsquo;ve just tried to use <a href="https://www.terraform.io">Terraform</a> and <a href="https://www.packer.io">Packer</a> to create a <a href="http://mesos.apache.org">Mesos</a> + <a href="http://ceph.com">Ceph</a> cluster in <a href="http://aws.amazon.com">AWS</a>. Yes, I know <a href="http://mesosphere.com">Mesosphere</a> applications supporting deployment of Mesos cluster in some IaaS (see <a href="http://mesosphere.com/docs/getting-started">Getting Started</a>), but I&rsquo;d like to understand what&rsquo;s going on there. So, I did it by Terraform and Packer. I&rsquo;m gonna explain a little bit more about this.</p>

<p>Through this work, I&rsquo;ve learned a lot of things. I will write something below too.</p>

<!-- more -->


<h2>What is this?</h2>

<p>This repository includes Terraform module and Packer template. Terraform module will manage a VPC subnet, igw, sg, etc. and instances below:</p>

<ul>
<li>admin

<ul>
<li>ssh gateway</li>
<li>run <code>ceph-deploy</code></li>
</ul>
</li>
<li>master1, master2, master3

<ul>
<li>mesos master</li>
<li>marathon</li>
<li>ceph mon</li>
<li>ceph mds</li>
<li>mount cephfs</li>
</ul>
</li>
<li>slaves (default 3)

<ul>
<li>mesos slave</li>
<li>ceph osd with EBS</li>
<li>mount cephfs</li>
</ul>
</li>
</ul>


<p>Why not only Mesos, did I manage Ceph cluster? In Mesos, I&rsquo;d like to use a shared file system because:</p>

<ul>
<li>Share executer files, etc.</li>
<li>Control cluster software on Mesos</li>
<li>Save uploaded files to Mesos tasks (ex. image files to blog apps)</li>
</ul>


<p>Or just for fun :)</p>

<h2>How to use?</h2>

<p>Very simple, make your own terraform config like below:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>provider "aws" {}
</span><span class='line'>
</span><span class='line'>resource "aws_vpc" "default" {
</span><span class='line'>        cidr_block           = "10.0.0.0/16"
</span><span class='line'>        enable_dns_support   = true
</span><span class='line'>        enable_dns_hostnames = true
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>module "mesos_ceph" {
</span><span class='line'>        source                   = "github.com/riywo/mesos-ceph/terraform"
</span><span class='line'>        vpc_id                   = "${aws_vpc.default.id}"
</span><span class='line'>        key_name                 = "${var.key_name}"
</span><span class='line'>        key_path                 = "${var.key_path}"
</span><span class='line'>        subnet_availability_zone = "us-east-1e"
</span><span class='line'>        subnet_cidr_block        = "10.0.1.0/24"
</span><span class='line'>        master1_ip               = "10.0.1.11"
</span><span class='line'>        master2_ip               = "10.0.1.12"
</span><span class='line'>        master3_ip               = "10.0.1.13"
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>Note: You can use environment variables for AWS configuration and <code>terraform.tfvars</code> file for variables.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>export AWS_REGION=us-east-1
</span><span class='line'>export AWS_ACCESS_KEY=AAAAAAAAAA
</span><span class='line'>export AWS_SECRET_KEY=000000000000000000
</span><span class='line'>
</span><span class='line'>$ cat terraform.tfvars
</span><span class='line'>key_name = "your key name"
</span><span class='line'>key_path = "/path/to/private_pem_file"</span></code></pre></td></tr></table></div></figure>


<p>First, you should download the module using <code>terraform get</code></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ terraform get
</span><span class='line'>Get: git::https://github.com/riywo/mesos-ceph.git</span></code></pre></td></tr></table></div></figure>


<p>Then, you can check <code>terraform plan</code>. To show resources in module, you have to provide <code>-module-depth</code> option.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
<span class='line-number'>148</span>
<span class='line-number'>149</span>
<span class='line-number'>150</span>
<span class='line-number'>151</span>
<span class='line-number'>152</span>
<span class='line-number'>153</span>
<span class='line-number'>154</span>
<span class='line-number'>155</span>
<span class='line-number'>156</span>
<span class='line-number'>157</span>
<span class='line-number'>158</span>
<span class='line-number'>159</span>
<span class='line-number'>160</span>
<span class='line-number'>161</span>
<span class='line-number'>162</span>
<span class='line-number'>163</span>
<span class='line-number'>164</span>
<span class='line-number'>165</span>
<span class='line-number'>166</span>
<span class='line-number'>167</span>
<span class='line-number'>168</span>
<span class='line-number'>169</span>
<span class='line-number'>170</span>
<span class='line-number'>171</span>
<span class='line-number'>172</span>
<span class='line-number'>173</span>
<span class='line-number'>174</span>
<span class='line-number'>175</span>
<span class='line-number'>176</span>
<span class='line-number'>177</span>
<span class='line-number'>178</span>
<span class='line-number'>179</span>
<span class='line-number'>180</span>
<span class='line-number'>181</span>
<span class='line-number'>182</span>
<span class='line-number'>183</span>
<span class='line-number'>184</span>
<span class='line-number'>185</span>
<span class='line-number'>186</span>
<span class='line-number'>187</span>
<span class='line-number'>188</span>
<span class='line-number'>189</span>
<span class='line-number'>190</span>
<span class='line-number'>191</span>
<span class='line-number'>192</span>
<span class='line-number'>193</span>
<span class='line-number'>194</span>
<span class='line-number'>195</span>
<span class='line-number'>196</span>
<span class='line-number'>197</span>
<span class='line-number'>198</span>
<span class='line-number'>199</span>
<span class='line-number'>200</span>
<span class='line-number'>201</span>
<span class='line-number'>202</span>
<span class='line-number'>203</span>
<span class='line-number'>204</span>
<span class='line-number'>205</span>
<span class='line-number'>206</span>
<span class='line-number'>207</span>
<span class='line-number'>208</span>
<span class='line-number'>209</span>
<span class='line-number'>210</span>
<span class='line-number'>211</span>
<span class='line-number'>212</span>
<span class='line-number'>213</span>
<span class='line-number'>214</span>
<span class='line-number'>215</span>
<span class='line-number'>216</span>
<span class='line-number'>217</span>
<span class='line-number'>218</span>
<span class='line-number'>219</span>
<span class='line-number'>220</span>
<span class='line-number'>221</span>
<span class='line-number'>222</span>
<span class='line-number'>223</span>
<span class='line-number'>224</span>
<span class='line-number'>225</span>
<span class='line-number'>226</span>
<span class='line-number'>227</span>
<span class='line-number'>228</span>
<span class='line-number'>229</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ terraform plan -module-depth -1
</span><span class='line'>Refreshing Terraform state prior to plan...
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>The Terraform execution plan has been generated and is shown below.
</span><span class='line'>Resources are shown in alphabetical order for quick scanning. Green resources
</span><span class='line'>will be created (or destroyed and then created if an existing resource
</span><span class='line'>exists), yellow resources are being changed in-place, and red resources
</span><span class='line'>will be destroyed.
</span><span class='line'>
</span><span class='line'>Note: You didn't specify an "-out" parameter to save this plan, so when
</span><span class='line'>"apply" is called, Terraform can't guarantee this is what will execute.
</span><span class='line'>
</span><span class='line'>+ aws_vpc.default
</span><span class='line'>    cidr_block:           "" =&gt; "10.0.0.0/16"
</span><span class='line'>    enable_dns_hostnames: "" =&gt; "1"
</span><span class='line'>    enable_dns_support:   "" =&gt; "1"
</span><span class='line'>    main_route_table_id:  "" =&gt; "&lt;computed&gt;"
</span><span class='line'>
</span><span class='line'>+ module.mesos.aws_instance.admin
</span><span class='line'>    ami:               "" =&gt; "ami-06ef816e"
</span><span class='line'>    availability_zone: "" =&gt; "&lt;computed&gt;"
</span><span class='line'>    instance_type:     "" =&gt; "t2.micro"
</span><span class='line'>    key_name:          "" =&gt; "your key name"
</span><span class='line'>    private_dns:       "" =&gt; "&lt;computed&gt;"
</span><span class='line'>    private_ip:        "" =&gt; "&lt;computed&gt;"
</span><span class='line'>    public_dns:        "" =&gt; "&lt;computed&gt;"
</span><span class='line'>    public_ip:         "" =&gt; "&lt;computed&gt;"
</span><span class='line'>    security_groups.#: "" =&gt; "&lt;computed&gt;"
</span><span class='line'>    subnet_id:         "" =&gt; "${aws_subnet.public.id}"
</span><span class='line'>    tenancy:           "" =&gt; "&lt;computed&gt;"
</span><span class='line'>
</span><span class='line'>+ module.mesos.aws_instance.master1
</span><span class='line'>    ami:               "" =&gt; "ami-06ef816e"
</span><span class='line'>    availability_zone: "" =&gt; "&lt;computed&gt;"
</span><span class='line'>    instance_type:     "" =&gt; "t2.micro"
</span><span class='line'>    key_name:          "" =&gt; "your key name"
</span><span class='line'>    private_dns:       "" =&gt; "&lt;computed&gt;"
</span><span class='line'>    private_ip:        "" =&gt; "10.0.1.11"
</span><span class='line'>    public_dns:        "" =&gt; "&lt;computed&gt;"
</span><span class='line'>    public_ip:         "" =&gt; "&lt;computed&gt;"
</span><span class='line'>    security_groups.#: "" =&gt; "&lt;computed&gt;"
</span><span class='line'>    subnet_id:         "" =&gt; "${aws_subnet.public.id}"
</span><span class='line'>    tenancy:           "" =&gt; "&lt;computed&gt;"
</span><span class='line'>
</span><span class='line'>+ module.mesos.aws_instance.master2
</span><span class='line'>    ami:               "" =&gt; "ami-06ef816e"
</span><span class='line'>    availability_zone: "" =&gt; "&lt;computed&gt;"
</span><span class='line'>    instance_type:     "" =&gt; "t2.micro"
</span><span class='line'>    key_name:          "" =&gt; "your key name"
</span><span class='line'>    private_dns:       "" =&gt; "&lt;computed&gt;"
</span><span class='line'>    private_ip:        "" =&gt; "10.0.1.12"
</span><span class='line'>    public_dns:        "" =&gt; "&lt;computed&gt;"
</span><span class='line'>    public_ip:         "" =&gt; "&lt;computed&gt;"
</span><span class='line'>    security_groups.#: "" =&gt; "&lt;computed&gt;"
</span><span class='line'>    subnet_id:         "" =&gt; "${aws_subnet.public.id}"
</span><span class='line'>    tenancy:           "" =&gt; "&lt;computed&gt;"
</span><span class='line'>
</span><span class='line'>+ module.mesos.aws_instance.master3
</span><span class='line'>    ami:               "" =&gt; "ami-06ef816e"
</span><span class='line'>    availability_zone: "" =&gt; "&lt;computed&gt;"
</span><span class='line'>    instance_type:     "" =&gt; "t2.micro"
</span><span class='line'>    key_name:          "" =&gt; "your key name"
</span><span class='line'>    private_dns:       "" =&gt; "&lt;computed&gt;"
</span><span class='line'>    private_ip:        "" =&gt; "10.0.1.13"
</span><span class='line'>    public_dns:        "" =&gt; "&lt;computed&gt;"
</span><span class='line'>    public_ip:         "" =&gt; "&lt;computed&gt;"
</span><span class='line'>    security_groups.#: "" =&gt; "&lt;computed&gt;"
</span><span class='line'>    subnet_id:         "" =&gt; "${aws_subnet.public.id}"
</span><span class='line'>    tenancy:           "" =&gt; "&lt;computed&gt;"
</span><span class='line'>
</span><span class='line'>+ module.mesos.aws_instance.slaves.0
</span><span class='line'>    ami:                                  "" =&gt; "ami-06ef816e"
</span><span class='line'>    availability_zone:                    "" =&gt; "&lt;computed&gt;"
</span><span class='line'>    block_device.#:                       "" =&gt; "1"
</span><span class='line'>    block_device.0.delete_on_termination: "" =&gt; "1"
</span><span class='line'>    block_device.0.device_name:           "" =&gt; "/dev/sdb"
</span><span class='line'>    block_device.0.encrypted:             "" =&gt; ""
</span><span class='line'>    block_device.0.snapshot_id:           "" =&gt; ""
</span><span class='line'>    block_device.0.virtual_name:          "" =&gt; ""
</span><span class='line'>    block_device.0.volume_size:           "" =&gt; "30"
</span><span class='line'>    block_device.0.volume_type:           "" =&gt; ""
</span><span class='line'>    instance_type:                        "" =&gt; "t2.micro"
</span><span class='line'>    key_name:                             "" =&gt; "your key name"
</span><span class='line'>    private_dns:                          "" =&gt; "&lt;computed&gt;"
</span><span class='line'>    private_ip:                           "" =&gt; "&lt;computed&gt;"
</span><span class='line'>    public_dns:                           "" =&gt; "&lt;computed&gt;"
</span><span class='line'>    public_ip:                            "" =&gt; "&lt;computed&gt;"
</span><span class='line'>    security_groups.#:                    "" =&gt; "&lt;computed&gt;"
</span><span class='line'>    subnet_id:                            "" =&gt; "${aws_subnet.public.id}"
</span><span class='line'>    tenancy:                              "" =&gt; "&lt;computed&gt;"
</span><span class='line'>
</span><span class='line'>+ module.mesos.aws_instance.slaves.1
</span><span class='line'>    ami:                                  "" =&gt; "ami-06ef816e"
</span><span class='line'>    availability_zone:                    "" =&gt; "&lt;computed&gt;"
</span><span class='line'>    block_device.#:                       "" =&gt; "1"
</span><span class='line'>    block_device.0.delete_on_termination: "" =&gt; "1"
</span><span class='line'>    block_device.0.device_name:           "" =&gt; "/dev/sdb"
</span><span class='line'>    block_device.0.encrypted:             "" =&gt; ""
</span><span class='line'>    block_device.0.snapshot_id:           "" =&gt; ""
</span><span class='line'>    block_device.0.virtual_name:          "" =&gt; ""
</span><span class='line'>    block_device.0.volume_size:           "" =&gt; "30"
</span><span class='line'>    block_device.0.volume_type:           "" =&gt; ""
</span><span class='line'>    instance_type:                        "" =&gt; "t2.micro"
</span><span class='line'>    key_name:                             "" =&gt; "your key name"
</span><span class='line'>    private_dns:                          "" =&gt; "&lt;computed&gt;"
</span><span class='line'>    private_ip:                           "" =&gt; "&lt;computed&gt;"
</span><span class='line'>    public_dns:                           "" =&gt; "&lt;computed&gt;"
</span><span class='line'>    public_ip:                            "" =&gt; "&lt;computed&gt;"
</span><span class='line'>    security_groups.#:                    "" =&gt; "&lt;computed&gt;"
</span><span class='line'>    subnet_id:                            "" =&gt; "${aws_subnet.public.id}"
</span><span class='line'>    tenancy:                              "" =&gt; "&lt;computed&gt;"
</span><span class='line'>
</span><span class='line'>+ module.mesos.aws_instance.slaves.2
</span><span class='line'>    ami:                                  "" =&gt; "ami-06ef816e"
</span><span class='line'>    availability_zone:                    "" =&gt; "&lt;computed&gt;"
</span><span class='line'>    block_device.#:                       "" =&gt; "1"
</span><span class='line'>    block_device.0.delete_on_termination: "" =&gt; "1"
</span><span class='line'>    block_device.0.device_name:           "" =&gt; "/dev/sdb"
</span><span class='line'>    block_device.0.encrypted:             "" =&gt; ""
</span><span class='line'>    block_device.0.snapshot_id:           "" =&gt; ""
</span><span class='line'>    block_device.0.virtual_name:          "" =&gt; ""
</span><span class='line'>    block_device.0.volume_size:           "" =&gt; "30"
</span><span class='line'>    block_device.0.volume_type:           "" =&gt; ""
</span><span class='line'>    instance_type:                        "" =&gt; "t2.micro"
</span><span class='line'>    key_name:                             "" =&gt; "your key name"
</span><span class='line'>    private_dns:                          "" =&gt; "&lt;computed&gt;"
</span><span class='line'>    private_ip:                           "" =&gt; "&lt;computed&gt;"
</span><span class='line'>    public_dns:                           "" =&gt; "&lt;computed&gt;"
</span><span class='line'>    public_ip:                            "" =&gt; "&lt;computed&gt;"
</span><span class='line'>    security_groups.#:                    "" =&gt; "&lt;computed&gt;"
</span><span class='line'>    subnet_id:                            "" =&gt; "${aws_subnet.public.id}"
</span><span class='line'>    tenancy:                              "" =&gt; "&lt;computed&gt;"
</span><span class='line'>
</span><span class='line'>+ module.mesos.aws_internet_gateway.public
</span><span class='line'>    vpc_id: "" =&gt; "${var.vpc_id}"
</span><span class='line'>
</span><span class='line'>+ module.mesos.aws_route_table.public
</span><span class='line'>    route.#:             "" =&gt; "1"
</span><span class='line'>    route.0.cidr_block:  "" =&gt; "0.0.0.0/0"
</span><span class='line'>    route.0.gateway_id:  "" =&gt; "${aws_internet_gateway.public.id}"
</span><span class='line'>    route.0.instance_id: "" =&gt; ""
</span><span class='line'>    vpc_id:              "" =&gt; "${var.vpc_id}"
</span><span class='line'>
</span><span class='line'>+ module.mesos.aws_route_table_association.public
</span><span class='line'>    route_table_id: "" =&gt; "${aws_route_table.public.id}"
</span><span class='line'>    subnet_id:      "" =&gt; "${aws_subnet.public.id}"
</span><span class='line'>
</span><span class='line'>+ module.mesos.aws_security_group.maintenance
</span><span class='line'>    description:                 "" =&gt; "maintenance"
</span><span class='line'>    ingress.#:                   "" =&gt; "1"
</span><span class='line'>    ingress.0.cidr_blocks.#:     "" =&gt; "1"
</span><span class='line'>    ingress.0.cidr_blocks.0:     "" =&gt; "0.0.0.0/0"
</span><span class='line'>    ingress.0.from_port:         "" =&gt; "22"
</span><span class='line'>    ingress.0.protocol:          "" =&gt; "tcp"
</span><span class='line'>    ingress.0.security_groups.#: "" =&gt; "0"
</span><span class='line'>    ingress.0.self:              "" =&gt; "0"
</span><span class='line'>    ingress.0.to_port:           "" =&gt; "22"
</span><span class='line'>    name:                        "" =&gt; "maintenance"
</span><span class='line'>    owner_id:                    "" =&gt; "&lt;computed&gt;"
</span><span class='line'>    vpc_id:                      "" =&gt; "${var.vpc_id}"
</span><span class='line'>
</span><span class='line'>+ module.mesos.aws_security_group.master
</span><span class='line'>    description:                 "" =&gt; "master"
</span><span class='line'>    ingress.#:                   "" =&gt; "2"
</span><span class='line'>    ingress.0.cidr_blocks.#:     "" =&gt; "1"
</span><span class='line'>    ingress.0.cidr_blocks.0:     "" =&gt; "0.0.0.0/0"
</span><span class='line'>    ingress.0.from_port:         "" =&gt; "8080"
</span><span class='line'>    ingress.0.protocol:          "" =&gt; "tcp"
</span><span class='line'>    ingress.0.security_groups.#: "" =&gt; "0"
</span><span class='line'>    ingress.0.self:              "" =&gt; "0"
</span><span class='line'>    ingress.0.to_port:           "" =&gt; "8080"
</span><span class='line'>    ingress.1.cidr_blocks.#:     "" =&gt; "1"
</span><span class='line'>    ingress.1.cidr_blocks.0:     "" =&gt; "0.0.0.0/0"
</span><span class='line'>    ingress.1.from_port:         "" =&gt; "5050"
</span><span class='line'>    ingress.1.protocol:          "" =&gt; "tcp"
</span><span class='line'>    ingress.1.security_groups.#: "" =&gt; "0"
</span><span class='line'>    ingress.1.self:              "" =&gt; "0"
</span><span class='line'>    ingress.1.to_port:           "" =&gt; "5050"
</span><span class='line'>    name:                        "" =&gt; "master"
</span><span class='line'>    owner_id:                    "" =&gt; "&lt;computed&gt;"
</span><span class='line'>    vpc_id:                      "" =&gt; "${var.vpc_id}"
</span><span class='line'>
</span><span class='line'>+ module.mesos.aws_security_group.private
</span><span class='line'>    description:                 "" =&gt; "private"
</span><span class='line'>    ingress.#:                   "" =&gt; "3"
</span><span class='line'>    ingress.0.cidr_blocks.#:     "" =&gt; "0"
</span><span class='line'>    ingress.0.from_port:         "" =&gt; "0"
</span><span class='line'>    ingress.0.protocol:          "" =&gt; "udp"
</span><span class='line'>    ingress.0.security_groups.#: "" =&gt; "0"
</span><span class='line'>    ingress.0.self:              "" =&gt; "1"
</span><span class='line'>    ingress.0.to_port:           "" =&gt; "65535"
</span><span class='line'>    ingress.1.cidr_blocks.#:     "" =&gt; "0"
</span><span class='line'>    ingress.1.from_port:         "" =&gt; "-1"
</span><span class='line'>    ingress.1.protocol:          "" =&gt; "icmp"
</span><span class='line'>    ingress.1.security_groups.#: "" =&gt; "0"
</span><span class='line'>    ingress.1.self:              "" =&gt; "1"
</span><span class='line'>    ingress.1.to_port:           "" =&gt; "-1"
</span><span class='line'>    ingress.2.cidr_blocks.#:     "" =&gt; "0"
</span><span class='line'>    ingress.2.from_port:         "" =&gt; "0"
</span><span class='line'>    ingress.2.protocol:          "" =&gt; "tcp"
</span><span class='line'>    ingress.2.security_groups.#: "" =&gt; "0"
</span><span class='line'>    ingress.2.self:              "" =&gt; "1"
</span><span class='line'>    ingress.2.to_port:           "" =&gt; "65535"
</span><span class='line'>    name:                        "" =&gt; "private"
</span><span class='line'>    owner_id:                    "" =&gt; "&lt;computed&gt;"
</span><span class='line'>    vpc_id:                      "" =&gt; "${var.vpc_id}"
</span><span class='line'>
</span><span class='line'>+ module.mesos.aws_security_group.slave
</span><span class='line'>    description:                 "" =&gt; "slave"
</span><span class='line'>    ingress.#:                   "" =&gt; "1"
</span><span class='line'>    ingress.0.cidr_blocks.#:     "" =&gt; "1"
</span><span class='line'>    ingress.0.cidr_blocks.0:     "" =&gt; "0.0.0.0/0"
</span><span class='line'>    ingress.0.from_port:         "" =&gt; "5051"
</span><span class='line'>    ingress.0.protocol:          "" =&gt; "tcp"
</span><span class='line'>    ingress.0.security_groups.#: "" =&gt; "0"
</span><span class='line'>    ingress.0.self:              "" =&gt; "0"
</span><span class='line'>    ingress.0.to_port:           "" =&gt; "5051"
</span><span class='line'>    name:                        "" =&gt; "slave"
</span><span class='line'>    owner_id:                    "" =&gt; "&lt;computed&gt;"
</span><span class='line'>    vpc_id:                      "" =&gt; "${var.vpc_id}"
</span><span class='line'>
</span><span class='line'>+ module.mesos.aws_subnet.public
</span><span class='line'>    availability_zone:       "" =&gt; "us-east-1e"
</span><span class='line'>    cidr_block:              "" =&gt; "10.0.1.0/24"
</span><span class='line'>    map_public_ip_on_launch: "" =&gt; "1"
</span><span class='line'>    vpc_id:                  "" =&gt; "${var.vpc_id}"
</span><span class='line'>
</span><span class='line'>+ module.mesos.null_resource.init_ceph
</span></code></pre></td></tr></table></div></figure>


<p>Now, you can do <code>terraform apply</code> and look into instances or Mesos/Marathon UI.</p>

<h2>Inside Terraform module</h2>

<p>There are a few techniques to avoid some difficulties in cluster management and more.</p>

<h3>Ceph cluster initialization process</h3>

<p>To start using Ceph cluster and Ceph FS, you have to run some procedures like this:</p>

<ul>
<li>Create <code>ceph.conf</code> for the cluster</li>
<li>Deploy <code>ceph.conf</code> to <code>mon</code> servers, initialize each <code>mon</code> and gather keys generated on each servers</li>
<li>Deploy keys to <code>osd</code> servers and initialize each <code>osd</code></li>
<li>Deploy keys to <code>mds</code> servers and initialize each <code>mds</code></li>
<li>Create data and metadata OSD pool</li>
<li>Create Ceph FS using these pools</li>
<li>Mount Ceph FS pointing <code>mon</code> servers</li>
</ul>


<p>Since they are too complicated and stateful, there is a big problem to manage Ceph cluster by Terraform or others.</p>

<p><code>ceph-deploy</code> is a easy tool for these procedure, so I used it on the admin instance. But how can we run a initial procedure by Terraform?</p>

<p><code>null_resource</code> is the best way. See <a href="https://github.com/riywo/mesos-ceph/blob/17807b073803d92430adcba28b5e784615de2f02/terraform/init_ceph.tf">terraform/init_ceph.tf</a></p>

<p>After spinning up all instances, this resource runs provisioners to initialize Ceph cluster like above. Once created this virtual resource, this procedure won&rsquo;t be executed any more.</p>

<h3>Ceph initializing and provisioning</h3>

<p>Considering initializing process above, there are two types of resource creation; Initializing and provisioning.</p>

<p>Initializing means the completely initial timing. At this time, each instance doesn&rsquo;t need to be provisioned because the cluster initialization process will do everything.</p>

<p>Provisioning, on the other hand, means after the cluster is initialized. For example, when a master/slave/admin instance is terminated, Terraform tries to re-create the instance and this is provisioning. It is a little bit different process than initializing because the cluster already exists.</p>

<p>See <a href="https://github.com/riywo/mesos-ceph/blob/17807b073803d92430adcba28b5e784615de2f02/terraform/scripts/init_master.sh">terraform/scripts/init_master.sh</a>. <code>if ceph_initialized;</code> block is for this problem. So, all instances can be terminated anytime even after a Ceph cluster is initialized. Try terminate a instance and <code>terraform apply</code>!</p>

<h3>SSH gateway and provisioners</h3>

<p>Terraform provisioners assume the instance can be connected by ssh directly. In this module, I don&rsquo;t open ssh port for cluster instances except admin instance, so it is a SSH gateway.</p>

<p>If you configure <code>connection</code> block to the gateway instead of the actual instance, you can use provisioners, but they run on the gateway.</p>

<p>So, I copy AWS key file into the admin instance to be able to login to other instances (there is not a way to use agent forward so far).</p>

<p>For each instance provisioning, I upload script files prefixed by the instance id to prevent overwriting race condition. See <a href="https://github.com/riywo/mesos-ceph/blob/17807b073803d92430adcba28b5e784615de2f02/terraform/master1.tf">terraform/master1.tf</a>. <code>script_path</code> option for <code>connection</code> is undocumented so far, btw.</p>

<h3>Master IP addresses</h3>

<p>I want to fix master IP addresses because they are hardcoded anywhere. I tried Terraform variable as list of IP addresses, but so far it was impossible.</p>

<p>Because of that, I fixed the number of masters and created each <code>aws_instance</code> resource.</p>

<p>When the list variable feature is implemented, I will refactor these configuration.</p>

<h3>Concatenate provisioner scripts</h3>

<p>I use bash script for provisioners and there are a lot of common functions, so I wrote a shared script <a href="https://github.com/riywo/mesos-ceph/blob/17807b073803d92430adcba28b5e784615de2f02/terraform/scripts/header.sh">terraform/scripts/header.sh</a>.</p>

<p>To run each provisioner correctly, this file must be concatenated. Also, an entry point <code>main</code> must be concatenated. So I did like this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>provisioner "remote-exec" {
</span><span class='line'>      inline = [
</span><span class='line'>          "echo main foo bar | cat header.sh init_foo.sh - | bash"
</span><span class='line'>      ]
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>I think there are much better ways, though&hellip;</p>

<h2>Isolation between Terraform and Packer</h2>

<p>There is a philosophy:</p>

<ul>
<li>Packer

<ul>
<li>Install file resources from the Internet</li>
</ul>
</li>
<li>Terraform

<ul>
<li>Install only runtime information, like IP address

<ul>
<li>Do not fetch file resources from the Internet</li>
</ul>
</li>
</ul>
</li>
</ul>


<p>So, any <code>apt-get install</code> are done by Packer nor Terraform. This philosophy is like <a href="http://12factor.net/">The Twelve-Factor App</a>.</p>

<h2>BTW, <code>awk</code> is great</h2>

<p>I wanted a way to use the instance id built by Packer in Terraform automatically. I found that Packer has <code>-machine-readable</code> output option and it is CSV format. So, I started to write a processor script:</p>

<ul>
<li>Print the machine readable output as well as normal Packer output</li>
<li>Write <code>ami.tf</code> file using the instance id built just now</li>
</ul>


<p>See <a href="https://github.com/riywo/mesos-ceph/blob/17807b073803d92430adcba28b5e784615de2f02/packer/process">packer/process</a>. This is my first <code>awk</code> executable script. <code>awk</code> was very nice in this case and I could find a lot of <code>awk</code> tips.</p>

<h2>Understanding basystyle</h2>

<p><a href="https://github.com/progrium/bashstyle">progrium/bashstyle</a></p>

<p>To write complex shell script for Packer/Terraform, I read the bashstyle article above. I don&rsquo;t understand all of them, but there are tons of best practice.</p>

<h1>Conclusion</h1>

<p>It was fun!</p>

<p>Hey, wait a moment&hellip; At the beginning, I just wanted to run many applications on Mesos using Docker, for example WordPress, MySQL Galera Cluster, etc. To implement them, I needed a shared file system, so I started to learn about Ceph which I had an eye on before. To deploy the cluster into AWS, I needed some orchestration software, then started to see Terraform, Packer to create AMI&hellip; Too long yak shaving it was ;(</p>

<p>Now, let&rsquo;s start learning about Mesos/Marathon/Docker and many applications!</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">riywo</span></span>

      








  


<time datetime="2014-12-25T23:13:16+09:00" pubdate data-updated="true"></time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/aws/'>aws</a>, <a class='category' href='/blog/categories/ceph/'>ceph</a>, <a class='category' href='/blog/categories/mesos/'>mesos</a>, <a class='category' href='/blog/categories/packer/'>packer</a>, <a class='category' href='/blog/categories/terraform/'>terraform</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://tech.riywo.com/blog/2014/12/25/terraform-module-for-mesos-plus-ceph-cluster-and-packer-template/" data-via="riywo" data-counturl="http://tech.riywo.com/blog/2014/12/25/terraform-module-for-mesos-plus-ceph-cluster-and-packer-template/" >Tweet</a>
  
  
  
    <div class="fb-like" data-send="true" data-width="450" data-show-faces="false"></div>
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2013/12/20/fluentd-on-mesos-plus-docker-plus-marathon/" title="Previous Post: Fluentd on Mesos + Docker + Marathon">&laquo; Fluentd on Mesos + Docker + Marathon</a>
      
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2014/12/25/terraform-module-for-mesos-plus-ceph-cluster-and-packer-template/">Terraform module for Mesos + Ceph cluster and Packer template</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/12/20/fluentd-on-mesos-plus-docker-plus-marathon/">Fluentd on Mesos + Docker + Marathon</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/10/11/chown-with-users-default-group/">chown with user&#8217;s default group</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/09/29/mesos-tutorial-3/">mesos tutorial 3</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/09/28/mesos-tutorial-2/">mesos tutorial 2</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/riywo">@riywo</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'riywo',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 - riywo -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'riywotech';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://tech.riywo.com/blog/2014/12/25/terraform-module-for-mesos-plus-ceph-cluster-and-packer-template/';
        var disqus_url = 'http://tech.riywo.com/blog/2014/12/25/terraform-module-for-mesos-plus-ceph-cluster-and-packer-template/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>





  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
